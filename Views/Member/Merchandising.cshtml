@model CornerkickWebMvc.Models.MerchandisingModel

@{
  ViewBag.Title = "Merchandising";
  Layout = "~/Views/Shared/_Layout.cshtml";
}
<html style="height: 100%; min-height: 100%">
<head>
  <link rel="stylesheet" href="~/Content/DataTables/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script type="text/javascript" src="~/Scripts/jquery-2.0.0.min.js"></script>
  <script type="text/javascript" src="~/Scripts/jquery-ui-1.12.1.min.js"></script>
  <script type="text/javascript" src="~/Scripts/DataTables/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="~/Scripts/autoNumeric/autoNumeric-min.js"></script>

  <style>
    .disabledDiv {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>

  <script>
    var oTable;

    $(document).ready(function () {
      oTable = setTableItems();
    }); // $(document).ready

    function setTableItems() {
      return $('#tableItems').DataTable({
        "ajax": {
          "url": '@Url.Action("MerchandisingGetItems", "Member")',
          "type": 'GET',
          "dataType": "JSON",
          "cache": false,
          "contentType": "application/json; charset=utf-8"
        },
        "columns": [
          { "data": "iIx" },
          { "data": "iId" },
          { "data": "sName" },
          { "data": "iPresent" },
          { "data": "sPriceBasic" },
          { "data": null },
          { "data": "sPriceBuy" },
          { "data": null },
          { "data": null },
          { "data": "sPriceSell" },
          { "data": "iSold" }
        ],
        "paging": false,
        "info": false,
        "searching": false,
        "order": [[0, "asc"]],
        "language": {
          "emptyTable": "Keine Artikel verfügbar"
        },
        "columnDefs": [
          {
            "targets": [0, 1],
            "visible": false,
            "orderable": false,
            "searchable": false
          },
          {
            "targets": [2, 5, 9],
            "className": "dt-center"
          },
          {
            "targets": [3, 4, 6, 7, 8, 10],
            "className": "dt-right"
          },
          {
            "targets": 7,
            "defaultContent": '0.00',
            "data": null
          },
          {
            "targets": [8, 9],
            "defaultContent": '',
            "orderable": false,
            "searchable": false,
            "data": null
          }
        ],
        "fnRowCallback": function (nRow, aData, iDisplayIndex) {
          $(nRow).addClass('details-control');

          var itAmount = document.createElement("input");
          //itAmount.className = "itAutoNumeric";
          itAmount.type = "number";
          itAmount.style.width = "80px";
          itAmount.style.textAlign = "right";
          itAmount.value = 0;

          var itPrice = document.createElement("input");
          itPrice.type = "number";
          itPrice.style.width = "60px";
          itPrice.style.textAlign = "right";
          itPrice.value = aData.fPriceSell;

          var bnBuy = document.createElement("button");
          bnBuy.style.width = "80px";
          bnBuy.innerText = "kaufen";
          bnBuy.className = "btn btn-default";
          bnBuy.disabled = true;

          itAmount.addEventListener("keyup", function () {
            if (this.value) {
              this.style.backgroundColor = "white";
              getPrice(aData.iId, parseInt(this.value), $("td:eq(4)", nRow), $("td:eq(5)", nRow), bnBuy);
            } else {
              this.style.backgroundColor = "red";
            }
          });
          $('td:eq(3)', nRow).html(itAmount);

          itPrice.addEventListener("keyup", function () {
            if (this.value) {
              this.style.backgroundColor = "white";
              setPrice(aData.iId, this.value);
            } else {
              this.style.backgroundColor = "red";
            }
          });
          $('td:eq(7)', nRow).html(itPrice);

          bnBuy.addEventListener("click", function () {
            buyItem(aData.iId, parseInt(itAmount.value), $("td:eq(4)", nRow).text(), parseFloat(itPrice.value));
          });
          $('td:eq(6)', nRow).html(bnBuy);

          return nRow;
        }
      });
    }

    function getPrice(iItemId, iAmount, cell1, cell2, bnBuy) {
      $.ajax({
        url: '/Member/getMerchandisingPrice',
        type: "GET",
        dataType: "JSON",
        data: { iItemId: iItemId, iAmount: iAmount },
        success: function (fPrice) {
          cell1.text(fPrice.toFixed(2));
          cell2.text((fPrice * iAmount).toFixed(2));
          bnBuy.disabled = iAmount === 0;
        },
        error: function (xhr) {
          alert(xhr.responseText);
        }
      });
    }

    function setPrice(iItemId, fPrice) {
      $.ajax({
        url: '/Member/setMerchandisingItemPrice',
        type: "GET",
        dataType: "JSON",
        data: { iItemId: iItemId, fPrice: fPrice },
        success: function (bReturn) {
          //
        },
        error: function (xhr) {
          alert(xhr.responseText);
        }
      });
    }

    function buyItem(iItemId, iAmount, sPriceBuy, fPriceSell) {
      $.ajax({
        url: '/Member/buyMerchandisingItem',
        type: "POST",
        dataType: "JSON",
        data: { iItemId: iItemId, iAmount: iAmount, sPriceBuy: sPriceBuy, fPriceSell: fPriceSell },
        success: function (bReturn) {
          if (bReturn) {
            oTable.ajax.reload();
          }
        },
        error: function (xhr) {
          alert(xhr.responseText);
        }
      });
    }

    function takeMarketer() {
      $.ajax({
        url: '/Member/MerchandisingTakeMarketer',
        type: "POST",
        dataType: "JSON",
        success: function (bReturn) {
          if (bReturn) {
            window.location.reload(true);
          }
        },
        error: function (xhr) {
          alert(xhr.responseText);
        }
      });
    }
  </script>
</head>

<body style="width: 100%">
  <div>
    <div style="position: relative; margin-bottom: 40px">
      <h3>Vermarkter</h3>

      <table id="tableMarketer" style="position: relative; font-size: 16px" cellpadding="6" border="1">
        <tbody>
          <tr>
            @{
              if (Model.marketer == null) {
                <td><b>@MvcApplication.ckcore.ltMerchandisingMarketer[0].sName</b></td>
                <td>Angebot: @Model.sMarketerMoney</td>
                <td><button class="btn btn-default" style="width: 100px" onclick="takeMarketer()">annehmen</button></td>
              } else {
                <td><b>@Model.marketer.marketer.sName</b></td>
                <td>Bezahlt: @Model.sMarketerMoney</td>
              }
            }
            <td>Laufzeit: Saisonende</td>
          </tr>
          <!---Data and tags are dynamically generated--->
        </tbody>
      </table>
    </div>

    @*
    <label style="margin-left: 10px">
      Artikel:
      @Html.DropDownListFor(m => m.iItem, Model.sliMerchandisingItems, new { @class = "form-horizontal", @onchange = "update(this)", id = "sliMerchandisingItems" })
    </label>
    *@

    @{
      string sClassDisabled = "";
      if (Model.marketer != null) {
        sClassDisabled = " class=disabledDiv";
        <p><b>Sie das Merchandising einem Vermarkter überlassen</b></p>
      }
      if (!Model.bFanshopsAvailable) {
        sClassDisabled = " class=disabledDiv";
        <p><b>Sie benötigen mindestens einen <a href="/Member/StadiumSurroundings">Fanshop</a> um Ihr Merchandising selbst zu vermarkten</b></p>
      }
    }
    <div id="divTableItems" style="position: relative" @sClassDisabled>
      <h3>Artikel</h3>
      <table id="tableItems" style="position: relative; margin: 0px; width: auto" class="display responsive nowrap">
        <thead>
          <tr>
            <th>#</th>
            <th>id</th>
            <th>Artikel</th>
            <th>Lager</th>
            <th>Grundpreis</th>
            <th>Menge</th>
            <th>Preis/Stück</th>
            <th>Gesamtpreis</th>
            <th></th>
            <th>Verkaufspreis</th>
            <th>verkauft</th>
          </tr>
        </thead>
        <tbody>
          <!---Data and tags are dynamically generated--->
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
